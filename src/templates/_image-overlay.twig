<div id="craft-alt-page-search-overlay">
	<a id="craft-alt-page-search-btn" href="#" target="_blank">
		<svg
			id="craft-alt-page-search-icon"
			xmlns="http://www.w3.org/2000/svg"
			viewBox="0 0 612 612"
			fill="currentColor"
			aria-hidden="true"
			focusable="false"
		>
			<path
				d="M602.2,10.3c-10.5-10.5-45.7,0-58.7,4.5-17.3,5.9-32.8,14.8-46.6,26.6-37,31.5-68.6,74-105.1,106.5l-58.1-15.5c.5-6.9,9-9.3,11-15.7,6.9-22-18.7-44.2-39.4-33.5-7.9,4-27.4,31-33.5,31L62.7,56.1c-22.2-7.2-35.1,20.1-49.6,32.7l279,161.3c-26.2,28.9-58.4,55-84.1,84.1-21.2,24-38.6,53-58.4,78.3l-6.3.5-105.8-28.7c-10.3.2-25.3,19.7-32.2,27.1l106.7,59.5c2.6,3.6-13.2,26.7-8.8,35.4,6,12.1,33.7-9.2,38.5-5.8l62.4,104.7c7.1-8.2,23.7-19,23.9-30.6l-28.4-105.5c-.7-2.3-.5-4.2.5-6.3,1.8-3.6,41.2-29.2,48.4-34.8,41.4-32.3,76.6-70.9,113.9-107.6l162.2,279c10.6-14.1,34.5-25,32.7-44.5l-59.3-213.8c.3-6.4,27.2-25.7,31.3-33.8,10.5-20.4-11.5-46.5-33.5-39.4-6.4,2.1-8.8,10.5-15.7,11l-15.1-58.4c46.8-55.6,123.6-96.7,139.2-172.6,2-9.7,5.6-29.9-2-37.5Z"
			/>
		</svg>
		<span>review current page</span>
	</a>
</div>

<div id="craft-alt-checker-overlay">
	<div>
		<span id="craft-alt-text-display"></span>
		<a id="craft-alt-edit-btn" href="#" target="_blank">
			Edit
		</a>
	</div>
</div>

<script>
	(function () {
const overlay = document.getElementById('craft-alt-checker-overlay');
const txt = document.getElementById('craft-alt-text-display');
const btn = document.getElementById('craft-alt-edit-btn');
const pageSearchOverlay = document.getElementById('craft-alt-page-search-overlay');
const pageSearchBtn = document.getElementById('craft-alt-page-search-btn');
let activeImg = null;
const warnIcon = String.fromCodePoint(0x26A0);
const searchIcon = String.fromCodePoint(0x1F50D);
const darkGreen = '#0f5132';

// Find all tagged images
const images = document.querySelectorAll('img[data-cp-check-enabled="true"]');

// Show page-level search button if there are any images
if (images.length > 0) {
pageSearchOverlay.style.display = 'block';
pageSearchBtn.href = generatePageSearchUrl();
}

images.forEach(img => { // Add red border for images missing alt text
const alt = img.getAttribute('data-cp-alt-text');
if (! alt || alt.trim() === '') {
img.style.border = '2px solid ' + darkGreen;
img.style.boxSizing = 'border-box';
} else { // Remove border if alt text is present
img.style.border = 'none';
}

img.addEventListener('mouseenter', (e) => {
activeImg = img;
updateOverlay(img);
});

img.addEventListener('mouseleave', (e) => {
// Slight delay to allow moving mouse to the edit button if it overlaps?
// Actually, since we position the overlay ON the image, we just hide when leaving the image
// BUT we need to be careful if the overlay covers the mouse.
// Simplified: Hide immediately.
overlay.style.display = 'none';
activeImg = null;
});
});

// Keep overlay visible if we hover over the overlay itself (if needed)
overlay.addEventListener('mouseenter', () => overlay.style.display = 'block');
overlay.addEventListener('mouseleave', () => overlay.style.display = 'none');

function updateOverlay(img) {
const url = img.getAttribute('data-cp-edit-url');
const type = img.getAttribute('data-cp-edit-type'); // direct vs search
const alt = img.getAttribute('data-cp-alt-text');

// Update Text
if (! alt || alt.trim() === '') {
txt.innerText = warnIcon + ' EMPTY ALT';
txt.style.color = darkGreen;
} else {
txt.innerText = alt;
txt.style.color = darkGreen;
}

// Update Button
btn.href = url;
btn.innerText = (type === 'direct') ? 'Edit' : (searchIcon + ' Search');

// Position Overlay
const rect = img.getBoundingClientRect();

// Show it
overlay.style.display = 'block';
const overlayRect = overlay.getBoundingClientRect();

// Place overlay in the bottom-right corner of the image
// Use a small inset to avoid touching edges
const inset = 6;
const top = rect.bottom - overlayRect.height - inset;
const left = rect.right - overlayRect.width - inset;

overlay.style.top = top + 'px';
overlay.style.left = left + 'px';
}

function generatePageSearchUrl() { // Collect all unique filenames from images on the page
const assetIds = new Set();
const filenames = new Set();

images.forEach(img => {
const assetIdRaw = img.getAttribute('data-cp-asset-id');
const assetId = assetIdRaw ? parseInt(assetIdRaw, 10) : NaN;

if (! Number.isNaN(assetId) && assetId > 0) {
assetIds.add(assetId);
return;
}

const normalizedFilename = img.getAttribute('data-cp-search-filename');
if (normalizedFilename) {
filenames.add(normalizedFilename);
return;
}

const src = img.getAttribute('src');
if (! src) {
return;
}
const filename = src.split('/').pop().split('?')[0]; // Last-resort fallback from image URL
if (! filename) {
return;
}
const cleanFilename = filename.replace(/(_\d+x\d+|_thumb|_transform)(\.[a-z0-9]+)$/i, '$2');
filenames.add(cleanFilename);
});

// Prefer stable asset IDs, and only fall back to filename lookup when needed.
const idTerms = Array.from(assetIds).map(id => `id:${id}`);
const filenameTerms = Array.from(filenames).map(filename => `filename:"${filename}"`);
const searchTerms = [...idTerms, ...filenameTerms];
const searchQuery = searchTerms.join(' OR ');

// Return URL to AltPilot backend with the search query
return '/admin/alt-pilot?query=' + encodeURIComponent(searchQuery);
}
})();
</script>


<style>
	#craft-alt-page-search-overlay {
		display: none;
		position: fixed;
		z-index: 2147483646;
		top: 20px;
		right: 20px;
		pointer-events: auto;
	}

	#craft-alt-page-search-btn {
		background: #8FF5B3;
		color: #0f5132;
		text-decoration: none;
		padding: 6px 12px;
		border-radius: 999px;
		border: 1px solid #0f5132;
		font-weight: 500;
		font-size: 16px;
		font-family: system-ui, -apple-system, sans-serif;
		display: flex;
		align-items: center;
		gap: 8px;
		box-shadow: 0 6px 18px rgba(15, 81, 50, 0.18);
		transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease, box-shadow 150ms ease;
	}

	#craft-alt-page-search-btn:hover {
		background: #ddfce8;
	}

	#craft-alt-page-search-icon {
		width: 16px;
		height: 16px;
		display: block;
		flex: 0 0 auto;
	}

	#craft-alt-checker-overlay {
		display: none;
		position: fixed;
		z-index: 2147483647;
		pointer-events: none;
	}

	#craft-alt-checker-overlay > div {
		background: #ffffff;
		color: #0f5132;
		/* border: 1px solid #0f5132; */
		padding-left: 8px;
		border-radius: 999px;
		font-family: system-ui, -apple-system, sans-serif;
		font-size: 13px;
		display: flex;
		align-items: center;
		gap: 10px;
		box-shadow: 0 6px 20px rgba(15, 81, 50, 0.2);
	}

	#craft-alt-text-display {
		max-width: 220px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		color: #0f5132;
	}

	#craft-alt-edit-btn {
		pointer-events: auto;
		background: #8FF5B3;
		color: #0f5132;
		text-decoration: none;
		padding: 4px 10px;
		border-radius: 999px;
		border: 1px solid #0f5132;
		font-size: 15px;
		white-space: nowrap;
		transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease, box-shadow 150ms ease;
	}

	#craft-alt-edit-btn:hover {
		background: #ddfce8;
	}
</style>
