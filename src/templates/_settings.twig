{# @var plugin \szenario\craftaltpilot\AltPilot #}
{# @var settings \szenario\craftaltpilot\models\Settings #}

{% import '_includes/forms.twig' as forms %}

	<div class="pane" style="background-color: var(--yellow-050); border-color: var(--yellow-300);"> <p class="warning with-icon">
		This plugin relies on Craft's queue system to process alt text generation. For production environments, we strongly recommend using a CRON-based or daemonized queue runner instead of the default HTTP-triggered queue. See the
		<a href="https://craftcms.com/docs/5.x/system/queue.html#queue-runners" target="_blank" rel="noopener">
			Craft queue documentation
		</a>
		for setup instructions.
	</p>

</div>

<div class="pane" style="background-color: var(--blue-050); border-color: var(--blue-300);">
	<p class="notice with-icon">
		You can also manage alt text generation via console commands. Enter
		<code>php craft alt-pilot</code>
		to see the available commands.
	</p>
</div>

{{ forms.autosuggestField({
	label: "OpenAI API Key"|t("altpilot"),
	instructions: "The API key from your Open AI account"|t("altpilot"),
	id: "openAiApiKey",
	name: "openAiApiKey",
	suggestEnvVars: true,
	value: settings.openAiApiKey,
	errors: settings.getErrors("openAiApiKey"),
	required: true,
}) }}


{{ forms.checkboxSelectField({
	label: 'Volumes'|t('app'),
	id: 'volumeIDs',
	name: 'volumeIDs',
	instructions: "The volumes to generate the alt text for."|t("altpilot"),
	values: settings.volumeIDs ?? [],
	errors: settings.getErrors('volumeIDs'),
	options: craft.app.volumes.getAllVolumes()|map(volume => {
		value: volume.id,
		label: volume.name
	}),
}) }}

{{ forms.textareaField({
	label: 'Prompt'|t('app'),
	id: 'openAiPrompt',
	name: 'openAiPrompt',
	instructions: "The prompt which will be sent to OpenAI alongside the image to generate an alt text."|t("altpilot"),
	value: settings.openAiPrompt,
	placeholder: "Your OpenAI prompt goes here...",
	rows: 8,
	errors: settings.getErrors('openAiPrompt'),
}) }}

{{ forms.textareaField({
	label: 'Prompt Context'|t('app'),
	id: 'openAiPromptContext',
	name: 'openAiPromptContext',
	instructions: "Optional context that will be added as instruction #7 to the prompt, focusing attention on specific aspects. Use this to emphasize domain-specific details (e.g., 'plants and botanical details' for a gardening site, or 'medical equipment and procedures' for a healthcare site). This creates a 7th instruction that guides what the AI prioritizes when describing images."|t("altpilot"),
	value: settings.openAiPromptContext,
	placeholder: "Add domain-specific context here...",
	rows: 4,
	errors: settings.getErrors('openAiPromptContext'),
}) }}

{{ forms.selectField({
	label: 'Open AI Model'|t('app'),
	id: 'openAiModel',
	name: 'openAiModel',
	instructions: "The OpenAI model used to generate the response. We strongly recommend to use GPT-5 Nano. Using other models may lead to extraordinary costs and lower quality. For details, take a look at the calculator at the bottom of the [OpenAI pricing page](https://openai.com/api/pricing/#trigger_2L7BlliZjpyN3nKgx6ujVA). To find out which models are capable of vision OpenAI suggest to look [on the models page](https://platform.openai.com/docs/models)"|t("altpilot"),
	value: settings.openAiModel,
	errors: settings.getErrors('openAiModel'),
	options: [
		{value: 'gpt-5-nano', label: 'GPT-5 Nano — Fastest and cheapest option'},
		{value: 'gpt-4o-mini', label: 'GPT-4o Mini — Alternative to  GPT-5 Nano while being a non-reasoning model'},
		{value: 'gpt-4o', label: 'GPT-4o — Highest quality for complex images (better accuracy, more expensive)'},
	],
}) }}

{{ forms.checkboxField({
	label: 'Show Image Overlay'|t('app'),
	id: 'showImageOverlay',
	name: 'showImageOverlay',
	instructions: "Whether to show the image overlay in the frontend."|t("altpilot"),
	checked: settings.showImageOverlay,
	errors: settings.getErrors('showImageOverlay'),
}) }}


{# phpMaxExecutionTime is injected from settingsHtml in AltPilot.php #}
{% set phpMaxExecutionTime = phpMaxExecutionTime ?? 0 %}
{% set phpMaxExecutionTime = phpMaxExecutionTime is numeric ? phpMaxExecutionTime|integer : 0 %}
{% if phpMaxExecutionTime != 0 and phpMaxExecutionTime < 120 %}
	<div class="pane" style="background-color: var(--yellow-050); border-color: var(--yellow-300);">
		<p class="warning with-icon">
			{{ "PHP max_execution_time is set to {seconds}s. For stable OpenAI requests we recommend at least 120s. Consider increasing it in php.ini or the Craft general config."|t('app', { seconds: phpMaxExecutionTime }) }}
		</p>
	</div>
{% endif %}

<h2>internals</h2>

{{ forms.textField({
	label: 'Average Token Count'|t('app'),
	id: 'averageTokenCount',
	name: 'averageTokenCount',
	instructions: "The average number of tokens used per request."|t("altpilot"),
	value: settings.averageTokenCount,
	errors: settings.getErrors('averageTokenCount'),
}) }}

{{ forms.textField({
	label: 'Average Request Duration'|t('app'),
	id: 'averageRequestDuration',
	name: 'averageRequestDuration',
	instructions: "The average duration of a request in seconds."|t("altpilot"),
	value: settings.averageRequestDuration,
	errors: settings.getErrors('averageRequestDuration'),
}) }}</p>
